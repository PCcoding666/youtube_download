name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: registry.cn-hangzhou.aliyuncs.com
  NAMESPACE: youtube-download
  BACKEND_IMAGE: backend
  FRONTEND_IMAGE: frontend

jobs:
  # Frontend CI Job
  frontend-ci:
    name: Frontend CI
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for all branches and tags

      - name: Verify package-lock.json exists
        run: |
          if [ ! -f frontend/package-lock.json ]; then
            echo "Error: frontend/package-lock.json not found!"
            ls -la frontend/
            exit 1
          fi
          echo "âœ… package-lock.json found"
          echo "File size: $(wc -c < frontend/package-lock.json) bytes"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          # Remove cache temporarily to debug
          # cache: 'npm'
          # cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Type check
        working-directory: frontend
        run: npm run type-check

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist/
          retention-days: 1

  # Backend CI Job
  backend-ci:
    name: Backend CI
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        working-directory: backend
        run: |
          pip install -r requirements.txt
          pip install ruff pytest

      - name: Lint with ruff
        working-directory: backend
        run: |
          ruff check .
          ruff format --check .

      - name: Run tests
        working-directory: backend
        run: |
          # åªè¿è¡Œå•å…ƒæµ‹è¯•ï¼Œè·³è¿‡éœ€è¦å¤–éƒ¨æœåŠ¡çš„é›†æˆæµ‹è¯•å’Œå±æ€§æµ‹è¯•
          pytest tests/ -v --tb=short -k "not (agentgo or bgutil or integration or property)"

  # Build and Push Images
  build-and-push:
    name: Build & Push Images
    runs-on: ubuntu-latest
    needs: [frontend-ci, backend-ci]
    if: github.ref == 'refs/heads/main'
    outputs:
      backend-tag: ${{ steps.backend-image-tag.outputs.tag }}
      frontend-tag: ${{ steps.frontend-image-tag.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download frontend artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Aliyun Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.ALIYUN_REGISTRY_USERNAME }}
          password: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}

      - name: Extract metadata for backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.BACKEND_IMAGE }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Extract metadata for frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.FRONTEND_IMAGE }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: backend
          file: backend/Dockerfile
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Set backend image tag
        id: backend-image-tag
        run: echo "tag=${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.BACKEND_IMAGE }}:latest" >> $GITHUB_OUTPUT

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: frontend
          file: frontend/Dockerfile
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Set frontend image tag
        id: frontend-image-tag
        run: echo "tag=${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.FRONTEND_IMAGE }}:latest" >> $GITHUB_OUTPUT

  # Deploy to Production
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            set -e
            
            # è®¾ç½®å˜é‡
            REGISTRY="${{ env.REGISTRY }}"
            NAMESPACE="${{ env.NAMESPACE }}"
            BACKEND_TAG="${{ needs.build-and-push.outputs.backend-tag }}"
            FRONTEND_TAG="${{ needs.build-and-push.outputs.frontend-tag }}"
            DEPLOY_DIR="/opt/youtube-download"
            BACKUP_DIR="/opt/youtube-download/backups"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            
            echo "ğŸš€ å¼€å§‹éƒ¨ç½² - $TIMESTAMP"
            
            # åˆ›å»ºéƒ¨ç½²ç›®å½•
            sudo mkdir -p $DEPLOY_DIR $BACKUP_DIR
            cd $DEPLOY_DIR
            
            # åˆ›å»ºå¤‡ä»½
            echo "ğŸ’¾ åˆ›å»ºéƒ¨ç½²å¤‡ä»½..."
            sudo mkdir -p $BACKUP_DIR/$TIMESTAMP
            if [ -f docker-compose.yml ]; then
              sudo cp docker-compose.yml $BACKUP_DIR/$TIMESTAMP/
            fi
            if [ -f .env.production ]; then
              sudo cp .env.production $BACKUP_DIR/$TIMESTAMP/
            fi
            
            # ç™»å½•åˆ°é˜¿é‡Œäº‘é•œåƒä»“åº“
            echo "ğŸ” ç™»å½•é•œåƒä»“åº“..."
            echo "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}" | sudo docker login $REGISTRY -u "${{ secrets.ALIYUN_REGISTRY_USERNAME }}" --password-stdin
            
            # æ‹‰å–æœ€æ–°é•œåƒ
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°é•œåƒ..."
            sudo docker pull $BACKEND_TAG
            sudo docker pull $FRONTEND_TAG
            
            # æ›´æ–° docker-compose.yml
            echo "ğŸ“ æ›´æ–° docker-compose é…ç½®..."
            sudo tee docker-compose.yml > /dev/null <<EOF
            version: '3.8'
            
            services:
              backend:
                image: $BACKEND_TAG
                container_name: youtube-download-backend
                restart: unless-stopped
                ports:
                  - "8000:8000"
                env_file:
                  - .env.production
                volumes:
                  - ./downloads:/app/downloads
                  - ./logs:/app/logs
                networks:
                  - youtube-download
                healthcheck:
                  test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 40s
            
              frontend:
                image: $FRONTEND_TAG
                container_name: youtube-download-frontend
                restart: unless-stopped
                ports:
                  - "80:80"
                  - "443:443"
                depends_on:
                  backend:
                    condition: service_healthy
                networks:
                  - youtube-download
            
            networks:
              youtube-download:
                driver: bridge
            
            volumes:
              downloads:
              logs:
            EOF
            
            # æ»šåŠ¨æ›´æ–°åç«¯
            echo "ğŸ”„ æ›´æ–°åç«¯æœåŠ¡..."
            sudo docker-compose up -d backend
            
            # ç­‰å¾…åç«¯å¥åº·æ£€æŸ¥
            echo "ğŸ¥ ç­‰å¾…åç«¯å¥åº·æ£€æŸ¥..."
            for i in {1..30}; do
              if sudo docker-compose exec -T backend curl -f http://localhost:8000/api/v1/health > /dev/null 2>&1; then
                echo "âœ… åç«¯å¥åº·æ£€æŸ¥é€šè¿‡"
                break
              fi
              if [ $i -eq 30 ]; then
                echo "âŒ åç«¯å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå¼€å§‹å›æ»š..."
                sudo docker-compose down
                if [ -f $BACKUP_DIR/$TIMESTAMP/docker-compose.yml ]; then
                  sudo cp $BACKUP_DIR/$TIMESTAMP/docker-compose.yml ./
                  sudo docker-compose up -d
                fi
                exit 1
              fi
              echo "â³ ç­‰å¾…åç«¯å¯åŠ¨... ($i/30)"
              sleep 2
            done
            
            # æ›´æ–°å‰ç«¯
            echo "ğŸ¨ æ›´æ–°å‰ç«¯æœåŠ¡..."
            sudo docker-compose up -d frontend
            
            # æœ€ç»ˆå¥åº·æ£€æŸ¥
            echo "ğŸ” æœ€ç»ˆå¥åº·æ£€æŸ¥..."
            sleep 10
            if ! curl -f http://localhost > /dev/null 2>&1; then
              echo "âŒ å‰ç«¯å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå¼€å§‹å›æ»š..."
              sudo docker-compose down
              if [ -f $BACKUP_DIR/$TIMESTAMP/docker-compose.yml ]; then
                sudo cp $BACKUP_DIR/$TIMESTAMP/docker-compose.yml ./
                sudo docker-compose up -d
              fi
              exit 1
            fi
            
            # æ¸…ç†æ—§é•œåƒå’Œå¤‡ä»½
            echo "ğŸ§¹ æ¸…ç†æ—§èµ„æº..."
            sudo docker image prune -f
            
            # ä¿ç•™æœ€è¿‘5ä¸ªå¤‡ä»½
            cd $BACKUP_DIR
            sudo ls -t | tail -n +6 | sudo xargs -r rm -rf
            
            echo "âœ… éƒ¨ç½²æˆåŠŸå®Œæˆï¼"

      - name: Send success notification
        if: success()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            âœ… **éƒ¨ç½²æˆåŠŸ**
            
            ğŸ“¦ **ä»“åº“**: ${{ github.repository }}
            ğŸŒ¿ **åˆ†æ”¯**: ${{ github.ref_name }}
            ğŸ’¬ **æäº¤**: ${{ github.event.head_commit.message }}
            ğŸ‘¤ **ä½œè€…**: ${{ github.actor }}
            ğŸš€ **æœåŠ¡**: https://${{ secrets.SERVER_HOST }}
            
            ğŸ• **æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')

      - name: Send failure notification
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            âŒ **éƒ¨ç½²å¤±è´¥**
            
            ğŸ“¦ **ä»“åº“**: ${{ github.repository }}
            ğŸŒ¿ **åˆ†æ”¯**: ${{ github.ref_name }}
            ğŸ’¬ **æäº¤**: ${{ github.event.head_commit.message }}
            ğŸ‘¤ **ä½œè€…**: ${{ github.actor }}
            ğŸ”— **æ—¥å¿—**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ğŸ• **æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')