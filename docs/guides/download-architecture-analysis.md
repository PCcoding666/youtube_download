# YouTube 下载架构分析

## 验证结论

### 方案 B 可行性：部分可行

经过测试，发现以下情况：

#### AgentGo 直接提取 URL 的限制

| 格式 | 能否获取 | 原因 |
|------|---------|------|
| 360p 合并格式 | ✅ 可以 | 直接 URL，无需解密 |
| 720p+ 分离格式 | ❌ 不行 | 需要 signatureCipher 解密 |

**结论**: AgentGo 只能获取低分辨率格式，高清格式需要 yt-dlp 解密。

#### IP 一致性分析

```
AgentGo 浏览器 IP: 144.125.34.172 (美国)
本地代理 IP:      142.249.36.127 (不同)
```

**两个 IP 不同**，但当前能工作是因为：
- `android_sdkless` 和 `web_safari` client 对 IP 绑定不严格
- YouTube 的 URL 有效期内（约 6 小时）可以从不同 IP 访问

## 推荐架构

### 本地开发环境（中国大陆）

```
当前架构（可用但速度慢）:
┌─────────────────────────────────────────┐
│ yt-dlp (ClashX 代理) → 提取 URL         │
│ FFmpeg (ClashX 代理) → 下载视频         │
│ OSS (禁用代理) → 上传                   │
└─────────────────────────────────────────┘
速度: ~0.17-0.27 MB/s (受代理带宽限制)
```

### 生产环境（新加坡服务器）- 推荐

```
直连架构（快速稳定）:
┌─────────────────────────────────────────┐
│ yt-dlp (直连) → 提取 URL                │
│ FFmpeg (直连) → 下载视频                │
│ OSS (直连) → 上传                       │
└─────────────────────────────────────────┘
预期速度: 5-20 MB/s (取决于服务器带宽)
IP 一致性: ✅ 自然一致
```

## 部署到新加坡后的配置

### 1. 环境变量调整

```bash
# backend/.env (新加坡服务器)

# 禁用代理 - 直连 YouTube
# HTTP_PROXY=  # 注释掉或删除

# OSS 配置保持不变
OSS_ACCESS_KEY_ID=xxx
OSS_ACCESS_KEY_SECRET=xxx
OSS_ENDPOINT=oss-ap-southeast-1.aliyuncs.com
OSS_BUCKET=youtube-download-sg
```

### 2. 代码无需修改

当前代码已经支持：
- 如果 `HTTP_PROXY` 未设置，yt-dlp 和 FFmpeg 会直连
- OSS 上传时会自动禁用代理

### 3. AgentGo 的作用

部署后 AgentGo 仍然有用：
- 提供 cookies 和 visitor_data（提高成功率）
- 作为备用方案（如果直连被封）
- 多区域支持（us, uk, sg 等）

## 封禁风险评估

| 场景 | 风险 | 建议 |
|------|------|------|
| 个人使用 (<50/天) | 🟢 低 | 直连即可 |
| 小团队 (50-200/天) | 🟡 中 | 加限流 |
| 公开服务 (不限量) | 🔴 高 | 需要 IP 轮换 |

## 性能对比

| 环境 | 下载速度 | 原因 |
|------|---------|------|
| 本地 + ClashX | 0.17-0.27 MB/s | 代理带宽限制 |
| 新加坡直连 | 5-20 MB/s | 服务器带宽 |
| AgentGo 代理 | N/A | 不支持 HTTP 代理 |

## 结论

**方案 B（AgentGo 代理下载）不完全可行**，因为：
1. AgentGo 是浏览器自动化服务，不提供 HTTP 代理
2. 高清格式需要 yt-dlp 解密 signatureCipher

**推荐方案**：
- 部署到新加坡服务器后直连 YouTube
- 使用 AgentGo 获取认证信息（提高成功率）
- 本地开发继续使用 ClashX 代理

---

最后更新: 2026-01-20
